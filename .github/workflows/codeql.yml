name: "CodeQL SAST and SOOS Ingestion"

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:
  schedule:
    - cron: '30 1 * * 0'

permissions:
  contents: read
  security-events: write 

jobs: 
  analyze: 
    name: CodeQL and SOOS SAST Analysis
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        # CRITICAL: Change 'javascript' to your language if it's different
        language: [ 'javascript' ] 

    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      # 1. Initialize CodeQL
      - name: üèóÔ∏è Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      # 2. Autobuild (Only needed for compiled languages)
      - name: ‚öôÔ∏è Autobuild
        uses: github/codeql-action/autobuild@v3

      # 3. Perform CodeQL Analysis and Save SARIF
      - name: üîç Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          # This saves the SARIF file(s) into the 'codeql-results' directory
          output: codeql-results 
          
      # ----------------------------------------------------------------------------------
      # FIX 1 (Conflict Resolution): Copy SARIF file for SOOS
      # We use 'cp' to create a .sarif.json copy, preserving the original .sarif for GitHub upload.
      # ----------------------------------------------------------------------------------
      - name: üîÑ Copy CodeQL SARIF for SOOS Ingestion
        id: copy_sarif
        run: |
          CODEQL_LANG_SARIF="codeql-results/${{ matrix.language }}.sarif"
          SOOS_REQUIRED_JSON="codeql-results/${{ matrix.language }}.sarif.json"
          
          echo "Checking for CodeQL SARIF at: $CODEQL_LANG_SARIF"
          
          if [ -f "$CODEQL_LANG_SARIF" ]; then
            # Use 'cp' (copy)
            cp "$CODEQL_LANG_SARIF" "$SOOS_REQUIRED_JSON"
            echo "Successfully copied to $SOOS_REQUIRED_JSON for SOOS."
          else
            echo "CRITICAL ERROR: CodeQL SARIF file NOT FOUND at $CODEQL_LANG_SARIF."
            echo "
