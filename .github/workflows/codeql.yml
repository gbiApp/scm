name: "CodeQL SAST and SOOS Ingestion"

# Controls when the workflow will run
on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:
  schedule:
    - cron: '30 1 * * 0'

permissions:
  contents: read
  security-events: write # Required for CodeQL analysis and SARIF upload

jobs: 
  analyze: 
    name: CodeQL and SOOS SAST Analysis
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        # CRITICAL: Change 'javascript' to your language if it's different (e.g., 'python', 'go', 'java')
        language: [ 'javascript' ] 

    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      # 1. Initialize CodeQL
      - name: üèóÔ∏è Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      # 2. Autobuild (Only needed for compiled languages)
      - name: ‚öôÔ∏è Autobuild
        uses: github/codeql-action/autobuild@v3

      # 3. Perform CodeQL Analysis and Save SARIF
      - name: üîç Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          # This saves the SARIF file(s) into the 'codeql-results' directory as <language>.sarif
          output: codeql-results 
          
      # ----------------------------------------------------------------------------------
      # FIX 1: Copy SARIF file for SOOS (preserves the original .sarif for GitHub upload)
      # ----------------------------------------------------------------------------------
      - name: üîÑ Copy and Rename CodeQL SARIF for SOOS Ingestion
        id: copy_sarif
        run: |
          CODEQL_LANG="${{ matrix.language }}"
          CODEQL_SARIF_FILE="codeql-results/$CODEQL_LANG.sarif"
          SOOS_REQUIRED_FILE="codeql-results/$CODEQL_LANG.sarif.json"
          
          if [ -f "$CODEQL_SARIF_FILE" ]; then
            # Use 'cp' (copy) to create the new file required by SOOS
            cp "$CODEQL_SARIF_FILE" "$SOOS_REQUIRED_FILE"
            echo "Successfully copied $CODEQL_SARIF_FILE to $SOOS_REQUIRED_FILE for SOOS."
          else
            echo "Error: CodeQL SARIF file not found at $CODEQL_SARIF_FILE. Cannot proceed with SOOS ingestion."
            exit 1
          fi

      # ----------------------------------------------------
      # Upload the renamed SARIF copy to SOOS
      # ----------------------------------------------------
      - name: ‚¨ÜÔ∏è Upload CodeQL SARIF to SOOS
        if: always() 
        uses: soos-io/soos-sast-github-action@v1 
        with:
          client_id: ${{ secrets.SOOS_CLIENT_ID }}
          api_key: ${{ secrets.SOOS_API_KEY }}
          project_name: ${{ github.repository }} 
          build_version: ${{ github.sha }}
          # CRITICAL: Use the specific, renamed file path
          scan_file: codeql-results/${{ matrix.language }}.sarif.json 
          scan_type: SARIF 
          
      # ----------------------------------------------------------------------------------
      # Upload the ORIGINAL SARIF to GitHub (This step now succeeds as the file is present)
      # ----------------------------------------------------------------------------------
      - name: üì¶ Upload CodeQL SARIF to GitHub
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          # This still points to the original .sarif file, which was preserved by the 'cp' command
          sarif_file: codeql-results/*.sarif
